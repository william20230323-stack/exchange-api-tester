name: Exchange API æ¸¬è©¦å¥—ä»¶

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  api-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4

    - name: è¨­ç½® Python ç’°å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: å®‰è£ä¾è³´
      run: |
        pip install --upgrade pip
        pip install -r scripts/requirements.txt

    - name: ðŸš¦ é‹è¡Œ IP é€£é€šæ€§æ¸¬è©¦
      run: |
        echo "ðŸ”„ é–‹å§‹æ¸¬è©¦äº¤æ˜“æ‰€ IP é€£é€šæ€§..."
        echo "============================================"
        
        exchanges=(
          "api.binance.com"
          "api.kucoin.com" 
          "api.gateio.ws"
          "api.mexc.com"
          "api.huobi.pro"
          "api.bitget.com"
          "www.okx.com"
        )
        
        success_count=0
        total_count=${#exchanges[@]}
        
        for exchange in "${exchanges[@]}"; do
          if ping -c 2 -W 3 "$exchange" > /dev/null 2>&1; then
            echo "âœ… $exchange -> é€£æŽ¥é€šæš¢"
            ((success_count++))
          else
            echo "âŒ $exchange -> é€£æŽ¥å¤±æ•—"
          fi
        done
        
        echo "============================================"
        echo "ðŸ“Š æ¸¬è©¦çµæžœ: $success_count/$total_count å€‹äº¤æ˜“æ‰€å¯é”"
        echo "â±ï¸ æ¸¬è©¦æ™‚é–“: $(date '+%Y-%m-%d %H:%M:%S')"
        
        if [ $success_count -eq $total_count ]; then
          echo "ðŸŽ‰ æ‰€æœ‰äº¤æ˜“æ‰€IPé€£æŽ¥æ­£å¸¸ï¼"
        else
          echo "âš ï¸  éƒ¨åˆ†äº¤æ˜“æ‰€é€£æŽ¥ç•°å¸¸"
        fi

    - name: ðŸ“¡ é‹è¡Œ API æ•¸æ“šç²å–æ¸¬è©¦
      run: |
        echo "ðŸš€ é–‹å§‹APIæ•¸æ“šç²å–æ¸¬è©¦..."
        cd scripts
        python exchange_api_tester.py

    - name: ðŸ’¾ ä¿å­˜æ¸¬è©¦å ±å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: api-test-reports
        path: |
          scripts/exchange_api_test_report_*.txt
        retention-days: 30

    - name: ðŸ“ ç”Ÿæˆæ¸¬è©¦æ‘˜è¦
      if: always()
      run: |
        echo "## ðŸ“Š API æ¸¬è©¦çµæžœæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**é‹è¡Œæ™‚é–“:** $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æª¢æŸ¥æ˜¯å¦æœ‰å ±å‘Šæ–‡ä»¶
        if ls scripts/exchange_api_test_report_*.txt 1> /dev/null 2>&1; then
          REPORT_FILE=$(ls scripts/exchange_api_test_report_*.txt | head -1)
          echo "**æ¸¬è©¦å ±å‘Šå·²ç”Ÿæˆ**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          tail -10 "$REPORT_FILE" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ æœªç”Ÿæˆæ¸¬è©¦å ±å‘Šæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "è©³ç´°å ±å‘Šå¯åœ¨ Artifacts ä¸­ä¸‹è¼‰ã€‚" >> $GITHUB_STEP_SUMMARY
