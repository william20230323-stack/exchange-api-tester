name: äº¤æ˜“æ‰€APIè‡ªå‹•åŒ–æ¸¬è©¦

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTC 00:00ï¼ˆå°ç£æ™‚é–“08:00ï¼‰
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  run-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: 1. æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4

    - name: 2. è¨­ç½®Pythonç’°å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: 3. å®‰è£Pythonä¾è³´
      run: |
        pip install --upgrade pip
        pip install aiohttp

    - name: 4. ğŸ” HTTPé€£é€šæ€§æ¸¬è©¦
      run: |
        echo "ğŸš€ é–‹å§‹äº¤æ˜“æ‰€HTTPé€£é€šæ€§æ¸¬è©¦"
        echo "========================================"
        
        # å®‰è£å¿…è¦çš„å·¥å…·
        sudo apt-get update -q
        sudo apt-get install -y curl
        
        # äº¤æ˜“æ‰€APIç«¯é»åˆ—è¡¨
        exchanges=(
          "Binance|https://api.binance.com/api/v3/ping"
          "KuCoin|https://api.kucoin.com/api/v1/ping"
          "Gate.io|https://api.gateio.ws/api/v4/spot/tickers"
          "MEXC|https://api.mexc.com/api/v3/ping"
          "Huobi|https://api.huobi.pro/market/detail/merged"
          "Bitget|https://api.bitget.com/api/spot/v1/market/ticker"
          "OKX|https://www.okx.com/api/v5/market/ticker"
          "Pionex|https://api.pionex.com/api/v1/market/ticker"
        )
        
        success_count=0
        total_count=0
        
        for exchange_info in "${exchanges[@]}"; do
          IFS='|' read -r name url <<< "$exchange_info"
          ((total_count++))
          
          echo -n "æ¸¬è©¦ $name... "
          
          # ä½¿ç”¨curlæ¸¬è©¦é€£é€šæ€§ï¼ˆä¸æª¢æŸ¥ç‹€æ…‹ç¢¼ï¼Œåªæª¢æŸ¥æ˜¯å¦èƒ½é€£æ¥ï¼‰
          if curl --silent --connect-timeout 10 --max-time 15 --output /dev/null "$url" 2>/dev/null; then
            echo "âœ… é€£æ¥é€šæš¢"
            ((success_count++))
          else
            echo "âŒ é€£æ¥å¤±æ•—"
          fi
        done
        
        echo "========================================"
        echo "ğŸ“Š çµæœ: $success_count/$total_count å€‹äº¤æ˜“æ‰€å¯é”"
        echo "â±ï¸ æ™‚é–“: $(date '+%Y-%m-%d %H:%M:%S')"

    - name: 5. ğŸ“¡ APIæ•¸æ“šç²å–æ¸¬è©¦
      run: |
        echo "ğŸš€ é–‹å§‹APIæ•¸æ“šç²å–æ¸¬è©¦"
        
        # å‰µå»ºscriptsç›®éŒ„
        mkdir -p scripts
        
        # å‰µå»ºä¸»æ¸¬è©¦è…³æœ¬
        cat > scripts/test_exchanges.py << 'EOF'
#!/usr/bin/env python3
"""
äº¤æ˜“æ‰€APIæ•¸æ“šç²å–æ¸¬è©¦
æ¸¬è©¦å„äº¤æ˜“æ‰€çš„BTC/USDTäº¤æ˜“å°æ•¸æ“š
"""

import asyncio
import aiohttp
import time
import json
from datetime import datetime

async def test_exchange(session, name, url, params=None):
    """æ¸¬è©¦å–®å€‹äº¤æ˜“æ‰€API"""
    start_time = time.time()
    try:
        full_url = url
        if params:
            # ç°¡å–®çš„åƒæ•¸æ‹¼æ¥
            param_str = '&'.join([f"{k}={v}" for k, v in params.items()])
            full_url = f"{url}?{param_str}"
        
        async with session.get(full_url, timeout=aiohttp.ClientTimeout(total=15)) as response:
            elapsed = (time.time() - start_time) * 1000  # æ¯«ç§’
            
            if response.status == 200:
                try:
                    data = await response.json()
                    
                    # æª¢æŸ¥æ•¸æ“šæœ‰æ•ˆæ€§
                    if isinstance(data, dict) and len(data) > 0:
                        return {
                            "name": name,
                            "success": True,
                            "response_time": elapsed,
                            "status": response.status,
                            "data_size": len(json.dumps(data)),
                            "error": None
                        }
                    elif isinstance(data, list) and len(data) > 0:
                        return {
                            "name": name,
                            "success": True,
                            "response_time": elapsed,
                            "status": response.status,
                            "data_size": len(json.dumps(data)),
                            "error": None
                        }
                    else:
                        return {
                            "name": name,
                            "success": False,
                            "response_time": elapsed,
                            "status": response.status,
                            "data_size": 0,
                            "error": "ç„¡æ•ˆçš„æ•¸æ“šæ ¼å¼"
                        }
                        
                except json.JSONDecodeError:
                    return {
                        "name": name,
                        "success": False,
                        "response_time": elapsed,
                        "status": response.status,
                        "data_size": 0,
                        "error": "JSONè§£æå¤±æ•—"
                    }
            else:
                return {
                    "name": name,
                    "success": False,
                    "response_time": elapsed,
                    "status": response.status,
                    "data_size": 0,
                    "error": f"HTTP {response.status}"
                }
                
    except asyncio.TimeoutError:
        return {
            "name": name,
            "success": False,
            "response_time": (time.time() - start_time) * 1000,
            "status": "Timeout",
            "data_size": 0,
            "error": "è«‹æ±‚è¶…æ™‚"
        }
    except Exception as e:
        return {
            "name": name,
            "success": False,
            "response_time": (time.time() - start_time) * 1000,
            "status": "Error",
            "data_size": 0,
            "error": str(type(e).__name__)
        }

async def main():
    """ä¸»æ¸¬è©¦å‡½æ•¸"""
    print("=" * 60)
    print("ğŸ“Š äº¤æ˜“æ‰€APIæ•¸æ“šç²å–æ¸¬è©¦")
    print(f"ğŸ•’ é–‹å§‹æ™‚é–“: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("=" * 60)
    
    # äº¤æ˜“æ‰€APIé…ç½®
    exchanges = [
        {
            "name": "Binance",
            "url": "https://api.binance.com/api/v3/ticker/24hr",
            "params": {"symbol": "BTCUSDT"}
        },
        {
            "name": "KuCoin",
            "url": "https://api.kucoin.com/api/v1/market/orderbook/level1",
            "params": {"symbol": "BTC-USDT"}
        },
        {
            "name": "Gate.io",
            "url": "https://api.gateio.ws/api/v4/spot/tickers",
            "params": {"currency_pair": "BTC_USDT"}
        },
        {
            "name": "MEXC",
            "url": "https://api.mexc.com/api/v3/ticker/24hr",
            "params": {"symbol": "BTCUSDT"}
        },
        {
            "name": "Huobi",
            "url": "https://api.huobi.pro/market/detail/merged",
            "params": {"symbol": "btcusdt"}
        },
        {
            "name": "Bitget",
            "url": "https://api.bitget.com/api/spot/v1/market/ticker",
            "params": {"symbol": "BTCUSDT"}
        },
        {
            "name": "OKX",
            "url": "https://www.okx.com/api/v5/market/ticker",
            "params": {"instId": "BTC-USDT"}
        },
        {
            "name": "Pionex",
            "url": "https://api.pionex.com/api/v1/market/ticker",
            "params": {"symbol": "BTC_USDT"}
        }
    ]
    
    print(f"ğŸ” å°‡æ¸¬è©¦ {len(exchanges)} å€‹äº¤æ˜“æ‰€\n")
    
    results = []
    
    # å‰µå»ºHTTPæœƒè©±ï¼Œé™åˆ¶ä¸¦ç™¼é€£æ¥
    connector = aiohttp.TCPConnector(limit=3)
    async with aiohttp.ClientSession(connector=connector) as session:
        for exchange in exchanges:
            print(f"æ­£åœ¨æ¸¬è©¦ {exchange['name']}...")
            result = await test_exchange(
                session, 
                exchange['name'], 
                exchange['url'], 
                exchange.get('params')
            )
            results.append(result)
            
            # é¡¯ç¤ºçµæœ
            if result["success"]:
                print(f"  âœ… æˆåŠŸ ({result['response_time']:.0f}ms)")
            else:
                print(f"  âŒ å¤±æ•—: {result['error']} ({result['response_time']:.0f}ms)")
            
            # é¿å…è«‹æ±‚éå¿«
            await asyncio.sleep(1)
    
    print("\n" + "=" * 60)
    
    # çµ±è¨ˆçµæœ
    successful = [r for r in results if r["success"]]
    success_rate = (len(successful) / len(results)) * 100
    
    # è¨ˆç®—å¹³å‡éŸ¿æ‡‰æ™‚é–“
    if successful:
        avg_response = sum(r["response_time"] for r in successful) / len(successful)
        best_exchange = min(successful, key=lambda x: x["response_time"])
    else:
        avg_response = 0
        best_exchange = None
    
    print(f"ğŸ“ˆ æ¸¬è©¦å®Œæˆ!")
    print(f"âœ… æˆåŠŸ: {len(successful)}/{len(results)}")
    print(f"ğŸ“Š æˆåŠŸç‡: {success_rate:.1f}%")
    
    if successful:
        print(f"â±ï¸  å¹³å‡éŸ¿æ‡‰æ™‚é–“: {avg_response:.0f}ms")
        print(f"ğŸ† æœ€ä½³è¡¨ç¾: {best_exchange['name']} ({best_exchange['response_time']:.0f}ms)")
    
    # ç”Ÿæˆè©³ç´°å ±å‘Š
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    report_filename = f"exchange_test_report_{timestamp}.txt"
    
    report = [
        "=" * 50,
        "äº¤æ˜“æ‰€APIæ¸¬è©¦å ±å‘Š",
        f"ç”Ÿæˆæ™‚é–“: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}",
        f"æ¸¬è©¦äº¤æ˜“æ‰€æ•¸é‡: {len(exchanges)}",
        "=" * 50,
        ""
    ]
    
    # è©³ç´°çµæœ
    for result in results:
        status = "âœ… æˆåŠŸ" if result["success"] else "âŒ å¤±æ•—"
        report.append(f"{result['name']:12} {status}")
        report.append(f"    éŸ¿æ‡‰æ™‚é–“: {result['response_time']:.0f}ms")
        report.append(f"    ç‹€æ…‹: {result['status']}")
        if result["error"]:
            report.append(f"    éŒ¯èª¤: {result['error']}")
        if result["success"] and result["data_size"] > 0:
            report.append(f"    æ•¸æ“šå¤§å°: {result['data_size']} bytes")
        report.append("")
    
    report.append("=" * 50)
    report.append(f"ç¸½æˆåŠŸç‡: {success_rate:.1f}% ({len(successful)}/{len(results)})")
    
    if successful:
        report.append(f"å¹³å‡éŸ¿æ‡‰æ™‚é–“: {avg_response:.0f}ms")
        if best_exchange:
            report.append(f"æ¨è–¦äº¤æ˜“æ‰€: {best_exchange['name']} (æœ€å¿«éŸ¿æ‡‰)")
    
    report.append("=" * 50)
    
    # ä¿å­˜å ±å‘Š
    with open(report_filename, 'w', encoding='utf-8') as f:
        f.write("\n".join(report))
    
    print(f"\nğŸ“„ å ±å‘Šå·²ä¿å­˜: {report_filename}")
    print(f"ğŸ•’ çµæŸæ™‚é–“: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("=" * 60)

if __name__ == "__main__":
    asyncio.run(main())
EOF
        
        # è¨­ç½®åŸ·è¡Œæ¬Šé™ä¸¦é‹è¡Œ
        chmod +x scripts/test_exchanges.py
        cd scripts
        python test_exchanges.py

    - name: 6. ğŸ’¾ ä¿å­˜æ¸¬è©¦å ±å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: exchange-test-reports
        path: |
          exchange_test_report_*.txt
          scripts/exchange_test_report_*.txt
        retention-days: 30

    - name: 7. ğŸ“ ç”Ÿæˆæ¸¬è©¦æ‘˜è¦
      if: always()
      run: |
        echo "## ğŸ“Š äº¤æ˜“æ‰€APIæ¸¬è©¦çµæœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**æ¸¬è©¦å®Œæˆæ™‚é–“:** $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æŸ¥æ‰¾æœ€æ–°çš„æ¸¬è©¦å ±å‘Š
        latest_report=""
        for report in exchange_test_report_*.txt scripts/exchange_test_report_*.txt; do
          if [ -f "$report" ]; then
            latest_report="$report"
            break
          fi
        done
        
        if [ -n "$latest_report" ]; then
          echo "**æ¸¬è©¦çµæœæ‘˜è¦:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          # é¡¯ç¤ºå ±å‘Šçš„æ ¸å¿ƒéƒ¨åˆ†
          head -30 "$latest_report" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "å®Œæ•´å ±å‘Šå¯åœ¨å³å´ Artifacts ä¸‹è¼‰ã€‚" >> $GITHUB_STEP_SUMMARY
        else
          echo "**âš ï¸ æœªç”Ÿæˆæ¸¬è©¦å ±å‘Š**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è«‹æª¢æŸ¥ä¸Šæ–¹æ—¥èªŒæŸ¥çœ‹è©³ç´°éŒ¯èª¤ã€‚" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*ä¸‹æ¬¡æ¸¬è©¦å°‡åœ¨æ¯æ—¥ UTC 00:00 è‡ªå‹•åŸ·è¡Œ*" >> $GITHUB_STEP_SUMMARY
