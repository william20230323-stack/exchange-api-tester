name: API Connectivity Test

on:
  push:
    branches: [ main ]

jobs:
  api-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: '3.7'
        
    - name: Install aiohttp
      run: pip install aiohttp
        
    - name: Create test script
      run: |
        cat > api_test.py << 'END_PYTHON'
import asyncio
import aiohttp

async def test_api():
    exchanges = [
        ("Binance", "https://api.binance.com/api/v3/ping"),
        ("Coinbase", "https://api.coinbase.com/v2/time"),
        ("Kraken", "https://api.kraken.com/0/public/Time"),
    ]
    
    success = 0
    total = len(exchanges)
    
    async with aiohttp.ClientSession() as session:
        for name, url in exchanges:
            try:
                async with session.get(url, timeout=5) as resp:
                    if resp.status == 200:
                        print("OK: " + name)
                        success = success + 1
                    else:
                        print("FAIL: " + name + " - HTTP " + str(resp.status))
            except Exception as error:
                error_msg = str(error)
                if len(error_msg) > 100:
                    error_msg = error_msg[:100]
                print("ERROR: " + name + " - " + error_msg)
    
    print("")
    print("Total: " + str(total))
    print("Success: " + str(success))
    print("Failed: " + str(total - success))
    
    if success < total / 2:
        print("WARNING: More than half of tests failed")
        exit(1)

if __name__ == "__main__":
    asyncio.run(test_api())
END_PYTHON
        
    - name: Run API test
      run: python api_test.py
