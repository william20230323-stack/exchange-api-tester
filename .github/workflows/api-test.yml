name: API Connectivity Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 */6 * * *'  # 每6小時運行一次
  workflow_dispatch:  # 允許手動觸發

jobs:
  api-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: 1. 檢出代碼
      uses: actions/checkout@v3
      
    - name: 2. 設置Python環境
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: 3. 安裝必要依賴
      run: pip install aiohttp
        
    - name: 4. 執行API連通性檢查
      run: |
        echo "開始交易所API連通性測試"
        echo "================================"
        
        cat > test_api.py << 'EOF'
import asyncio
import aiohttp
import time
from datetime import datetime

async def test_exchange(session, name, url):
    start_time = time.time()
    try:
        async with session.get(url, timeout=10) as response:
            elapsed = (time.time() - start_time) * 1000
            if response.status == 200:
                try:
                    data = await response.json()
                    print(f'✓ {name}: 成功 (狀態碼: {response.status}, 耗時: {elapsed:.0f}ms)')
                    return {'name': name, 'status': 'success', 'response_time': elapsed, 'status_code': response.status}
                except:
                    text = await response.text()
                    if len(text) > 100:
                        text = text[:100] + '...'
                    print(f'✓ {name}: 成功 (狀態碼: {response.status}, 耗時: {elapsed:.0f}ms) - 響應: {text}')
                    return {'name': name, 'status': 'success', 'response_time': elapsed, 'status_code': response.status}
            else:
                print(f'✗ {name}: 失敗 (狀態碼: {response.status}, 耗時: {elapsed:.0f}ms)')
                return {'name': name, 'status': 'failed', 'response_time': elapsed, 'status_code': response.status}
    except asyncio.TimeoutError:
        elapsed = (time.time() - start_time) * 1000
        print(f'✗ {name}: 超時 (超過10秒)')
        return {'name': name, 'status': 'timeout', 'response_time': elapsed, 'status_code': None}
    except Exception as e:
        elapsed = (time.time() - start_time) * 1000
        error_msg = str(e)
        if len(error_msg) > 50:
            error_msg = error_msg[:50] + '...'
        print(f'✗ {name}: 錯誤 - {error_msg} (耗時: {elapsed:.0f}ms)')
        return {'name': name, 'status': 'error', 'response_time': elapsed, 'status_code': None, 'error': str(e)}

async def main():
    # 測試列表 - 使用交易所的ping或簡單API端點
    test_list = [
        ('Binance', 'https://api.binance.com/api/v3/ping'),
        ('KuCoin', 'https://api.kucoin.com/api/v1/ping'),
        ('Gate.io', 'https://api.gate.io/api/v4/spot/tickers?currency_pair=BTC_USDT'),
        ('MEXC', 'https://api.mexc.com/api/v3/ping'),
        ('Huobi', 'https://api.huobi.pro/market/detail/merged?symbol=btcusdt'),
        ('OKX', 'https://www.okx.com/api/v5/public/time'),
        ('Bybit', 'https://api.bybit.com/v5/market/time'),
        ('Coinbase', 'https://api.coinbase.com/v2/time'),
        ('Bitfinex', 'https://api-pub.bitfinex.com/v2/platform/status'),
        ('Kraken', 'https://api.kraken.com/0/public/Time')
    ]
    
    print(f'計劃測試 {len(test_list)} 個交易所')
    print('─' * 60)
    
    # 創建ClientSession，設置較長的總超時時間
    timeout = aiohttp.ClientTimeout(total=30)
    connector = aiohttp.TCPConnector(limit=10)  # 限制同時連接數
    
    async with aiohttp.ClientSession(timeout=timeout, connector=connector) as session:
        tasks = [test_exchange(session, name, url) for name, url in test_list]
        results = await asyncio.gather(*tasks)
    
    print('─' * 60)
    
    # 統計結果
    successful = sum(1 for r in results if r['status'] == 'success')
    failed = sum(1 for r in results if r['status'] == 'failed')
    timeout_count = sum(1 for r in results if r['status'] == 'timeout')
    error_count = sum(1 for r in results if r['status'] == 'error')
    
    print(f'測試完成時間: {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}')
    print(f'總計: {len(results)} | 成功: {successful} | 失敗: {failed} | 超時: {timeout_count} | 錯誤: {error_count}')
    
    # 如果有失敗的測試，列出詳細信息
    if failed + timeout_count + error_count > 0:
        print('\n失敗的交易所:')
        for r in results:
            if r['status'] != 'success':
                status_code = r.get('status_code', 'N/A')
                print(f'  • {r["name"]}: {r["status"]} (狀態碼: {status_code})')
    
    # 計算平均響應時間
    successful_times = [r['response_time'] for r in results if r['status'] == 'success']
    if successful_times:
        avg_time = sum(successful_times) / len(successful_times)
        print(f'平均響應時間: {avg_time:.0f}ms')
    
    # 如果有超過一半的測試失敗，則退出碼為1（表示失敗）
    if successful < len(test_list) / 2:
        print('警告: 超過一半的API測試失敗！')
        exit(1)

if __name__ == '__main__':
    asyncio.run(main())
EOF

        python3 test_api.py
        
    - name: 5. 生成測試報告
      if: always()
      run: |
        echo "API測試已完成"
        echo "測試報告生成時間: $(date)"
        echo "詳情請查看上方輸出"
