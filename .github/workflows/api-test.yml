name: Exchange API æ¸¬è©¦å¥—ä»¶

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯å¤© UTC 00:00 è‡ªå‹•é‹è¡Œï¼ˆå°ç£æ™‚é–“ 08:00ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  api-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4

    - name: è¨­ç½® Python ç’°å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: å®‰è£ä¾è³´
      run: |
        pip install --upgrade pip
        pip install aiohttp colorama

    - name: ðŸ” é‹è¡Œ HTTP é€£é€šæ€§æ¸¬è©¦
      run: |
        echo "ðŸ”„ é–‹å§‹æ¸¬è©¦äº¤æ˜“æ‰€ HTTP é€£é€šæ€§..."
        echo "============================================"
        
        # å®‰è£ curlï¼ˆå¦‚æžœæ²’æœ‰ï¼‰
        if ! command -v curl &> /dev/null; then
          echo "å®‰è£ curl..."
          sudo apt-get update && sudo apt-get install -y curl
        fi
        
        # æ¸¬è©¦çš„äº¤æ˜“æ‰€APIç«¯é»žåˆ—è¡¨
        exchanges=(
          "https://api.binance.com/api/v3/ping"
          "https://api.kucoin.com/api/v1/ping"
          "https://api.gateio.ws/api/v4/spot/tickers?currency_pair=BTC_USDT"
          "https://api.mexc.com/api/v3/ping"
          "https://api.huobi.pro/market/detail/merged?symbol=btcusdt"
          "https://api.bitget.com/api/spot/v1/market/ticker?symbol=BTCUSDT"
          "https://www.okx.com/api/v5/market/ticker?instId=BTC-USDT"
          "https://api.pionex.com/api/v1/market/ticker?symbol=BTC_USDT"
        )
        
        success_count=0
        total_count=${#exchanges[@]}
        
        for api_url in "${exchanges[@]}"; do
          # æå–äº¤æ˜“æ‰€åç¨±
          exchange_name=""
          case $api_url in
            *binance*) exchange_name="Binance" ;;
            *kucoin*) exchange_name="KuCoin" ;;
            *gateio*) exchange_name="Gate.io" ;;
            *mexc*) exchange_name="MEXC" ;;
            *huobi*) exchange_name="Huobi" ;;
            *bitget*) exchange_name="Bitget" ;;
            *okx*) exchange_name="OKX" ;;
            *pionex*) exchange_name="Pionex" ;;
            *) exchange_name="Unknown" ;;
          esac
          
          echo -n "æ¸¬è©¦ $exchange_name... "
          
          # ä½¿ç”¨curlæ¸¬è©¦HTTPé€£é€šæ€§
          if curl --silent --max-time 10 --output /dev/null --head --fail "$api_url" 2>/dev/null; then
            echo "âœ… é€£æŽ¥é€šæš¢"
            ((success_count++))
          else
            echo "âŒ é€£æŽ¥å¤±æ•—"
          fi
        done
        
        echo "============================================"
        echo "ðŸ“Š HTTPé€£é€šæ€§çµæžœ: $success_count/$total_count å€‹äº¤æ˜“æ‰€å¯é”"
        echo "â±ï¸ æ¸¬è©¦æ™‚é–“: $(date '+%Y-%m-%d %H:%M:%S')"
        
        if [ $success_count -eq $total_count ]; then
          echo "ðŸŽ‰ æ‰€æœ‰äº¤æ˜“æ‰€HTTPé€£æŽ¥æ­£å¸¸ï¼"
        elif [ $success_count -gt 0 ]; then
          echo "âš ï¸  éƒ¨åˆ†äº¤æ˜“æ‰€é€£æŽ¥ç•°å¸¸"
        else
          echo "âŒ æ‰€æœ‰äº¤æ˜“æ‰€é€£æŽ¥å¤±æ•—"
        fi

    - name: ðŸ“¡ é‹è¡Œ API æ•¸æ“šç²å–æ¸¬è©¦
      run: |
        echo "ðŸš€ é–‹å§‹APIæ•¸æ“šç²å–æ¸¬è©¦..."
        cd scripts
        
        # æª¢æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "exchange_api_tester.py" ]; then
          echo "âŒ æ‰¾ä¸åˆ°æ¸¬è©¦è…³æœ¬ exchange_api_tester.py"
          exit 1
        fi
        
        # é‹è¡Œæ¸¬è©¦
        python exchange_api_tester.py
        
        # æª¢æŸ¥æ¸¬è©¦å ±å‘Š
        if ls exchange_api_test_report_*.txt 1> /dev/null 2>&1; then
          echo "ðŸ“„ æ¸¬è©¦å ±å‘Šå·²ç”Ÿæˆ"
        else
          echo "âš ï¸  æœªç”Ÿæˆæ¸¬è©¦å ±å‘Šæ–‡ä»¶"
        fi

    - name: ðŸ’¾ ä¿å­˜æ¸¬è©¦å ±å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: api-test-reports
        path: |
          scripts/exchange_api_test_report_*.txt
        retention-days: 30

    - name: ðŸ“ ç”Ÿæˆæ¸¬è©¦æ‘˜è¦
      if: always()
      run: |
        echo "## ðŸ“Š API æ¸¬è©¦çµæžœæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**é‹è¡Œæ™‚é–“:** $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "**é‹è¡Œç‹€æ…‹:** âœ… æˆåŠŸå®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æª¢æŸ¥æ˜¯å¦æœ‰å ±å‘Šæ–‡ä»¶
        if ls scripts/exchange_api_test_report_*.txt 1> /dev/null 2>&1; then
          REPORT_FILE=$(ls scripts/exchange_api_test_report_*.txt | head -1)
          echo "**æ¸¬è©¦å ±å‘Šæ‘˜è¦:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          # é¡¯ç¤ºå ±å‘Šçš„æœ€å¾Œ15è¡Œ
          tail -15 "$REPORT_FILE" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
        else
          echo "**âš ï¸ æœªç”Ÿæˆæ¸¬è©¦å ±å‘Šæ–‡ä»¶**" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "è©³ç´°å ±å‘Šå¯åœ¨å³å´ Artifacts ä¸­ä¸‹è¼‰ã€‚" >> $GITHUB_STEP_SUMMARY
