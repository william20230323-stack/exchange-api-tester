name: äº¤æ˜“æ‰€APIè¿é€šæ€§æµ‹è¯•

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  test-exchanges:
    runs-on: ubuntu-latest
    timeout-minutes: 5  # è®¾ç½®è¶…æ—¶ï¼Œé˜²æ­¢å¡ä½

    steps:
    # ç¬¬ä¸€æ­¥ï¼šè·å–ä»£ç 
    - name: ğŸ›’ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    # ç¬¬äºŒæ­¥ï¼šå‡†å¤‡Pythonç¯å¢ƒ
    - name: ğŸ è®¾ç½®Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # ç¬¬ä¸‰æ­¥ï¼šå®‰è£…å¿…è¦çš„PythonåŒ…
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        pip install --upgrade pip
        pip install aiohttp

    # ç¬¬å››æ­¥ï¼šè¿è¡Œæ ¸å¿ƒæµ‹è¯•è„šæœ¬
    - name: ğŸš€ è¿è¡ŒAPIæµ‹è¯•
      run: |
        echo "å¼€å§‹æµ‹è¯•å¤šä¸ªäº¤æ˜“æ‰€APIè¿é€šæ€§..."
        echo "======================================"
        
        # å°†æµ‹è¯•è„šæœ¬ç›´æ¥å†…åµŒåœ¨å·¥ä½œæµä¸­ï¼Œé¿å…å¤–éƒ¨æ–‡ä»¶ä¾èµ–
        python3 << 'EOF'
import asyncio
import aiohttp
import time
from datetime import datetime

async def test_single_exchange(session, name, url):
    """æµ‹è¯•å•ä¸ªäº¤æ˜“æ‰€"""
    start_time = time.time()
    try:
        # è®¾ç½®10ç§’è¶…æ—¶ï¼Œé¿å…é•¿æ—¶é—´ç­‰å¾…
        timeout = aiohttp.ClientTimeout(total=10)
        async with session.get(url, timeout=timeout) as response:
            elapsed_ms = (time.time() - start_time) * 1000
            
            # åˆ¤æ–­æˆåŠŸæ¡ä»¶ï¼šèƒ½æ”¶åˆ°å“åº”ï¼ˆå³ä½¿æ˜¯é200çŠ¶æ€ç ä¹Ÿè§†ä¸ºç½‘ç»œè¿é€šï¼‰
            if response.status == 200:
                return {"name": name, "ok": True, "time": elapsed_ms, "msg": f"HTTP {response.status}"}
            else:
                # èƒ½æ”¶åˆ°å“åº”ä½†çŠ¶æ€ç é200ï¼Œä¹Ÿè§†ä¸ºç½‘ç»œå¯è¿é€š
                return {"name": name, "ok": True, "time": elapsed_ms, "msg": f"HTTP {response.status} (çŠ¶æ€å¼‚å¸¸ä½†ç½‘ç»œé€š)"}
    except asyncio.TimeoutError:
        elapsed_ms = (time.time() - start_time) * 1000
        return {"name": name, "ok": False, "time": elapsed_ms, "msg": "è¶…æ—¶"}
    except Exception as e:
        elapsed_ms = (time.time() - start_time) * 1000
        return {"name": name, "ok": False, "time": elapsed_ms, "msg": f"{type(e).__name__}"}

async def main():
    print(f"æµ‹è¯•å¼€å§‹æ—¶é—´: {datetime.now().strftime('%H:%M:%S')}")
    print("--------------------------------------")
    
    # è¦æµ‹è¯•çš„äº¤æ˜“æ‰€APIåˆ—è¡¨ï¼ˆä½¿ç”¨ç¨³å®šã€ç®€å•çš„æ¥å£ï¼‰
    exchanges_to_test = [
        ("Binance", "https://api.binance.com/api/v3/ping"),
        ("KuCoin", "https://api.kucoin.com/api/v1/ping"),
        ("Gate.io", "https://api.gateio.ws/api/v4/spot/tickers?currency_pair=BTC_USDT"),
        ("MEXC", "https://api.mexc.com/api/v3/ping"),
        ("OKX", "https://www.okx.com/api/v5/market/ticker?instId=BTC-USDT"),
    ]
    
    all_results = []
    
    # åˆ›å»ºHTTPä¼šè¯ï¼Œå¹¶é™åˆ¶å¹¶å‘è¿æ¥æ•°ï¼Œé¿å…è¢«APIé™åˆ¶
    connector = aiohttp.TCPConnector(limit=3)
    async with aiohttp.ClientSession(connector=connector) as session:
        # é€ä¸ªæµ‹è¯•ï¼Œè€Œéå¹¶å‘ï¼Œæé«˜ç¨³å®šæ€§
        for exchange in exchanges_to_test:
            name, url = exchange
            result = await test_single_exchange(session, name, url)
            all_results.append(result)
            
            # ç«‹å³æ‰“å°ç»“æœï¼Œæ–¹ä¾¿å®æ—¶æŸ¥çœ‹
            status_icon = "âœ…" if result["ok"] else "âŒ"
            print(f"{status_icon} {name:12} {result['msg']:30} ({result['time']:5.0f} ms)")
            
            # æ¯ä¸ªè¯·æ±‚ä¹‹é—´é—´éš”0.5ç§’ï¼Œç¤¼è²Œè®¿é—®
            await asyncio.sleep(0.5)
    
    # æ‰“å°æ±‡æ€»æŠ¥å‘Š
    print("\n======================================")
    print("ğŸ“Š æµ‹è¯•ç»“æœæ±‡æ€»")
    print("======================================")
    
    successful = [r for r in all_results if r["ok"]]
    success_rate = (len(successful) / len(all_results)) * 100
    
    print(f"æµ‹è¯•æ€»æ•°: {len(all_results)}")
    print(f"æˆåŠŸæ•°é‡: {len(successful)}")
    print(f"æˆåŠŸç‡: {success_rate:.1f}%")
    
    if successful:
        avg_time = sum(r["time"] for r in successful) / len(successful)
        fastest = min(successful, key=lambda x: x["time"])
        print(f"å¹³å‡å“åº”æ—¶é—´: {avg_time:.0f} ms")
        print(f"æœ€å¿«å“åº”: {fastest['name']} ({fastest['time']:.0f} ms)")
    
    print(f"\næµ‹è¯•ç»“æŸæ—¶é—´: {datetime.now().strftime('%H:%M:%S')}")

# è¿è¡Œä¸»å‡½æ•°
if __name__ == "__main__":
    asyncio.run(main())
EOF
        
        echo "======================================"
        echo "APIè¿é€šæ€§æµ‹è¯•æ‰§è¡Œå®Œæ¯•ï¼"

    # ç¬¬äº”æ­¥ï¼šæ€»æ˜¯æ‰§è¡Œçš„æˆåŠŸæç¤º
    - name: âœ… æµ‹è¯•å®Œæˆ
      if: always()  # å³ä½¿å‰é¢æ­¥éª¤å¤±è´¥ï¼Œä¹Ÿæ‰§è¡Œæ­¤æ­¥éª¤
      run: |
        echo "æœ¬æ¬¡GitHub Actionsè¿è¡Œå·²ç»“æŸã€‚"
        echo "è¯·æŸ¥çœ‹ä¸Šæ–¹ã€è¿è¡ŒAPIæµ‹è¯•ã€æ­¥éª¤çš„è¾“å‡ºï¼Œè·å–è¯¦ç»†ç»“æœã€‚"
