name: Exchange API æ¸¬è©¦å¥—ä»¶

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  api-test:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - name: æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4

    - name: è¨­ç½® Python ç’°å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: å®‰è£ä¾è³´
      run: |
        pip install --upgrade pip
        pip install aiohttp

    - name: ðŸ” é‹è¡Œ HTTP é€£é€šæ€§æ¸¬è©¦
      run: |
        echo "é–‹å§‹æ¸¬è©¦äº¤æ˜“æ‰€ HTTP é€£é€šæ€§..."
        echo "========================================"
        
        # å®‰è£ curlï¼ˆå¦‚æžœæ²’æœ‰ï¼‰
        if ! command -v curl &> /dev/null; then
          sudo apt-get update && sudo apt-get install -y curl
        fi
        
        # äº¤æ˜“æ‰€åˆ—è¡¨ - æ”¹ç‚ºç°¡å–®çš„GETè«‹æ±‚ï¼Œä¸æª¢æŸ¥ç‹€æ…‹ç¢¼
        declare -A exchanges=(
          ["Binance"]="https://api.binance.com/api/v3/ping"
          ["KuCoin"]="https://api.kucoin.com/api/v1/ping"
          ["Gate.io"]="https://api.gateio.ws/api/v4/spot/tickers"
          ["MEXC"]="https://api.mexc.com/api/v3/ping"
          ["Huobi"]="https://api.huobi.pro/market/detail/merged"
          ["Bitget"]="https://api.bitget.com/api/spot/v1/market/ticker"
          ["OKX"]="https://www.okx.com/api/v5/market/ticker"
          ["Pionex"]="https://api.pionex.com/api/v1/market/ticker"
        )
        
        success_count=0
        total_count=0
        
        for name in "${!exchanges[@]}"; do
          url="${exchanges[$name]}"
          ((total_count++))
          
          echo -n "æ¸¬è©¦ $name... "
          
          # ç°¡å–®æ¸¬è©¦ï¼šåªæª¢æŸ¥æ˜¯å¦èƒ½å»ºç«‹é€£æŽ¥ï¼Œä¸æª¢æŸ¥éŸ¿æ‡‰å…§å®¹
          # ä½¿ç”¨ --connect-timeout è€Œä¸æ˜¯ --max-time
          # ä½¿ç”¨ --silent éš±è—é€²åº¦ï¼Œä½¿ç”¨ --output /dev/null ä¸Ÿæ£„éŸ¿æ‡‰
          # ä½¿ç”¨ --head åªè«‹æ±‚é ­éƒ¨ï¼Œæ¸›å°‘æ•¸æ“šå‚³è¼¸
          # ä¸ä½¿ç”¨ --failï¼Œé€™æ¨£å³ä½¿è¿”å›žéŒ¯èª¤ç‹€æ…‹ç¢¼ä¹Ÿæœƒç¹¼çºŒ
          if curl --silent --connect-timeout 3 --max-time 5 --head "$url" &>/dev/null; then
            echo "âœ… é€£æŽ¥é€šæš¢"
            ((success_count++))
          else
            echo "âŒ é€£æŽ¥å¤±æ•—"
          fi
        done
        
        echo "========================================"
        echo "çµæžœ: $success_count/$total_count å€‹äº¤æ˜“æ‰€å¯é”"
        echo "æ™‚é–“: $(date '+%Y-%m-%d %H:%M:%S')"
        
        # å³ä½¿æœ‰å¤±æ•—ï¼Œä¹Ÿç¹¼çºŒåŸ·è¡Œå¾ŒçºŒæ­¥é©Ÿ
        echo "HTTPé€£é€šæ€§æ¸¬è©¦å®Œæˆï¼Œç¹¼çºŒåŸ·è¡ŒAPIæ¸¬è©¦..."

    - name: ðŸ“¡ é‹è¡Œ API æ•¸æ“šç²å–æ¸¬è©¦
      run: |
        echo "é–‹å§‹ API æ•¸æ“šç²å–æ¸¬è©¦..."
        echo "å‰µå»ºæ¸¬è©¦è…³æœ¬..."
        
        # å‰µå»ºscriptsç›®éŒ„
        mkdir -p scripts
        
        # å‰µå»ºæ›´ç°¡å–®ç©©å®šçš„æ¸¬è©¦è…³æœ¬
        cat > scripts/simple_test.py << 'EOF'
#!/usr/bin/env python3
"""
æ¥µç°¡APIæ¸¬è©¦ - ç©©å®šæ€§å„ªå…ˆ
"""

import asyncio
import aiohttp
import time
from datetime import datetime

async def test_exchange(session, name, url):
    """æ¸¬è©¦å–®å€‹äº¤æ˜“æ‰€"""
    start_time = time.time()
    try:
        async with session.get(url, timeout=aiohttp.ClientTimeout(total=10)) as response:
            elapsed = (time.time() - start_time) * 1000  # è½‰ç‚ºæ¯«ç§’
            
            # åªè¦æ²’æœ‰æ‹‹å‡ºç•°å¸¸ï¼Œå°±èªç‚ºé€£æŽ¥æˆåŠŸ
            # ä¸æª¢æŸ¥ç‹€æ…‹ç¢¼ï¼Œå› ç‚ºæœ‰äº›APIå¯èƒ½è¿”å›žéž200ä½†é€£æŽ¥æ˜¯é€šçš„
            print(f"âœ… {name}: é€£æŽ¥æˆåŠŸ ({elapsed:.0f}ms)")
            return {
                "name": name,
                "success": True,
                "response_time": elapsed,
                "status": response.status
            }
    except asyncio.TimeoutError:
        elapsed = (time.time() - start_time) * 1000
        print(f"âŒ {name}: é€£æŽ¥è¶…æ™‚ ({elapsed:.0f}ms)")
        return {
            "name": name,
            "success": False,
            "response_time": elapsed,
            "status": "Timeout"
        }
    except Exception as e:
        elapsed = (time.time() - start_time) * 1000
        print(f"âŒ {name}: é€£æŽ¥éŒ¯èª¤ - {type(e).__name__} ({elapsed:.0f}ms)")
        return {
            "name": name,
            "success": False,
            "response_time": elapsed,
            "status": str(type(e).__name__)
        }

async def main():
    """ä¸»æ¸¬è©¦å‡½æ•¸"""
    print("=" * 50)
    print("äº¤æ˜“æ‰€APIé€£æŽ¥æ¸¬è©¦")
    print(f"é–‹å§‹æ™‚é–“: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("=" * 50)
    
    # åªæ¸¬è©¦æœ€é—œéµçš„APIç«¯é»ž
    exchanges = [
        ("Binance", "https://api.binance.com/api/v3/ping"),
        ("KuCoin", "https://api.kucoin.com/api/v1/ping"),
        ("Gate.io", "https://api.gateio.ws/api/v4/spot/tickers?currency_pair=BTC_USDT"),
        ("MEXC", "https://api.mexc.com/api/v3/ping"),
        ("Huobi", "https://api.huobi.pro/market/detail/merged?symbol=btcusdt"),
        ("Bitget", "https://api.bitget.com/api/spot/v1/market/ticker?symbol=BTCUSDT"),
        ("OKX", "https://www.okx.com/api/v5/market/ticker?instId=BTC-USDT"),
        ("Pionex", "https://api.pionex.com/api/v1/market/ticker?symbol=BTC_USDT"),
    ]
    
    print(f"å°‡æ¸¬è©¦ {len(exchanges)} å€‹äº¤æ˜“æ‰€...\n")
    
    # é™åˆ¶ä¸¦ç™¼æ•¸ï¼Œé¿å…è§¸ç™¼APIé™åˆ¶
    connector = aiohttp.TCPConnector(limit=2)
    
    async with aiohttp.ClientSession(connector=connector) as session:
        results = []
        for name, url in exchanges:
            result = await test_exchange(session, name, url)
            results.append(result)
            await asyncio.sleep(0.5)  # å¢žåŠ é–“éš”ï¼Œé¿å…è«‹æ±‚éŽå¿«
    
    print("\n" + "=" * 50)
    
    # çµ±è¨ˆçµæžœ
    success_results = [r for r in results if r["success"]]
    success_rate = (len(success_results) / len(results)) * 100
    
    print(f"æ¸¬è©¦å®Œæˆ!")
    print(f"æˆåŠŸçŽ‡: {len(success_results)}/{len(results)} ({success_rate:.1f}%)")
    
    # ç”Ÿæˆå ±å‘Š
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    filename = f"api_test_report_{timestamp}.txt"
    
    with open(filename, 'w') as f:
        f.write("=" * 40 + "\n")
        f.write("äº¤æ˜“æ‰€APIé€£æŽ¥æ¸¬è©¦å ±å‘Š\n")
        f.write(f"æ™‚é–“: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
        f.write("=" * 40 + "\n")
        
        for result in results:
            status = "âœ… æˆåŠŸ" if result["success"] else "âŒ å¤±æ•—"
            f.write(f"{result['name']:10} {status} ({result['response_time']:.0f}ms)\n")
        
        f.write("=" * 40 + "\n")
        f.write(f"æˆåŠŸçŽ‡: {len(success_results)}/{len(results)} ({success_rate:.1f}%)\n")
        f.write("=" * 40 + "\n")
    
    print(f"å ±å‘Šå·²ä¿å­˜: {filename}")
    print(f"çµæŸæ™‚é–“: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("=" * 50)

if __name__ == "__main__":
    asyncio.run(main())
EOF
        
        # è¨­ç½®åŸ·è¡Œæ¬Šé™
        chmod +x scripts/simple_test.py
        
        # é‹è¡Œæ¸¬è©¦
        echo "é‹è¡Œæ¸¬è©¦è…³æœ¬..."
        cd scripts
        python simple_test.py

    - name: ðŸ’¾ ä¿å­˜æ¸¬è©¦å ±å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: api-test-reports
        path: |
          scripts/api_test_report_*.txt
          api_test_report_*.txt
        retention-days: 30

    - name: ðŸ“ ç”Ÿæˆæ¸¬è©¦æ‘˜è¦
      if: always()
      run: |
        echo "## API æ¸¬è©¦çµæžœæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**é‹è¡Œæ™‚é–“:** $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æª¢æŸ¥å ±å‘Šæ–‡ä»¶
        report_count=0
        
        # æª¢æŸ¥å¤šå€‹å¯èƒ½çš„è·¯å¾‘
        for report_file in scripts/api_test_report_*.txt api_test_report_*.txt; do
          if [ -f "$report_file" ]; then
            ((report_count++))
            echo "**æ¸¬è©¦çµæžœ:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "```" >> $GITHUB_STEP_SUMMARY
            cat "$report_file" >> $GITHUB_STEP_SUMMARY
            echo "```" >> $GITHUB_STEP_SUMMARY
            break
          fi
        done
        
        if [ $report_count -eq 0 ]; then
          echo "**âš ï¸ æœªç”Ÿæˆæ¸¬è©¦å ±å‘Š**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "å¯èƒ½çš„åŽŸå› ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "1. æ¸¬è©¦è…³æœ¬åŸ·è¡Œå¤±æ•—" >> $GITHUB_STEP_SUMMARY
          echo "2. ç¶²çµ¡é€£æŽ¥å•é¡Œ" >> $GITHUB_STEP_SUMMARY
          echo "3. æ–‡ä»¶æ¬Šé™å•é¡Œ" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "è©³ç´°æ—¥èªŒè«‹æŸ¥çœ‹ä¸Šæ–¹çš„é‹è¡Œè¨˜éŒ„ã€‚" >> $GITHUB_STEP_SUMMARY
