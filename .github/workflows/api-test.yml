name: Exchange API æ¸¬è©¦å¥—ä»¶

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  run-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - name: æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4

    - name: è¨­ç½® Python ç’°å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: å®‰è£ä¾è³´
      run: |
        pip install --upgrade pip
        pip install aiohttp

    - name: ðŸ” æ¸¬è©¦ HTTP é€£é€šæ€§
      run: |
        echo "é–‹å§‹æ¸¬è©¦äº¤æ˜“æ‰€ HTTP é€£é€šæ€§..."
        echo "========================================"
        
        # æ›´æ–°ä¸¦å®‰è£ curl
        sudo apt-get update -q
        sudo apt-get install -y curl
        
        # äº¤æ˜“æ‰€ API åˆ—è¡¨
        declare -A exchanges=(
          ["Binance"]="https://api.binance.com/api/v3/ping"
          ["KuCoin"]="https://api.kucoin.com/api/v1/ping"
          ["Gate.io"]="https://api.gateio.ws/api/v4/spot/tickers"
          ["MEXC"]="https://api.mexc.com/api/v3/ping"
          ["Huobi"]="https://api.huobi.pro/market/detail/merged"
          ["Bitget"]="https://api.bitget.com/api/spot/v1/market/ticker"
          ["OKX"]="https://www.okx.com/api/v5/market/ticker"
          ["Pionex"]="https://api.pionex.com/api/v1/market/ticker"
        )
        
        success_count=0
        total_count=0
        
        for name in "${!exchanges[@]}"; do
          url="${exchanges[$name]}"
          ((total_count++))
          
          echo -n "æ¸¬è©¦ $name... "
          
          # ç°¡å–®çš„é€£æŽ¥æ¸¬è©¦ï¼Œä¸æª¢æŸ¥ç‹€æ…‹ç¢¼
          if curl --silent --connect-timeout 5 --max-time 10 --output /dev/null "$url"; then
            echo "âœ… æˆåŠŸ"
            ((success_count++))
          else
            echo "âŒ å¤±æ•—"
          fi
        done
        
        echo "========================================"
        echo "HTTPé€£é€šæ€§çµæžœ: $success_count/$total_count"
        echo "æ¸¬è©¦æ™‚é–“: $(date '+%Y-%m-%d %H:%M:%S')"

    - name: ðŸ“¡ é‹è¡Œ API æ•¸æ“šæ¸¬è©¦
      run: |
        echo "é–‹å§‹ API æ•¸æ“šæ¸¬è©¦..."
        
        # å‰µå»º scripts ç›®éŒ„
        mkdir -p scripts
        
        # å‰µå»ºç°¡å–®çš„ Python æ¸¬è©¦è…³æœ¬
        cat > scripts/test_exchanges.py << 'EOF'
#!/usr/bin/env python3
import asyncio
import aiohttp
import time
from datetime import datetime

async def main():
    print("=" * 50)
    print("äº¤æ˜“æ‰€ API æ¸¬è©¦")
    print(f"é–‹å§‹æ™‚é–“: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("=" * 50)
    
    exchanges = [
        ("Binance", "https://api.binance.com/api/v3/ping"),
        ("KuCoin", "https://api.kucoin.com/api/v1/ping"),
        ("Gate.io", "https://api.gateio.ws/api/v4/spot/tickers?currency_pair=BTC_USDT"),
        ("MEXC", "https://api.mexc.com/api/v3/ping"),
        ("Huobi", "https://api.huobi.pro/market/detail/merged?symbol=btcusdt"),
        ("Bitget", "https://api.bitget.com/api/spot/v1/market/ticker?symbol=BTCUSDT"),
        ("OKX", "https://www.okx.com/api/v5/market/ticker?instId=BTC-USDT"),
        ("Pionex", "https://api.pionex.com/api/v1/market/ticker?symbol=BTC_USDT"),
    ]
    
    results = []
    
    async with aiohttp.ClientSession() as session:
        for name, url in exchanges:
            start = time.time()
            try:
                async with session.get(url, timeout=aiohttp.ClientTimeout(total=10)) as resp:
                    elapsed = time.time() - start
                    if resp.status == 200:
                        print(f"âœ… {name}: æˆåŠŸ ({elapsed*1000:.0f}ms)")
                        results.append((name, True, elapsed))
                    else:
                        print(f"âš ï¸  {name}: HTTP {resp.status} ({elapsed*1000:.0f}ms)")
                        results.append((name, False, elapsed))
            except Exception as e:
                elapsed = time.time() - start
                print(f"âŒ {name}: {type(e).__name__} ({elapsed*1000:.0f}ms)")
                results.append((name, False, elapsed))
    
    print("=" * 50)
    
    # ç”Ÿæˆå ±å‘Š
    success = sum(1 for r in results if r[1])
    total = len(results)
    
    report = [
        "=" * 40,
        "äº¤æ˜“æ‰€ API æ¸¬è©¦å ±å‘Š",
        f"æ™‚é–“: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}",
        "=" * 40
    ]
    
    for name, ok, elapsed in results:
        status = "âœ… æˆåŠŸ" if ok else "âŒ å¤±æ•—"
        report.append(f"{name:10} {status} ({elapsed*1000:.0f}ms)")
    
    report.append("=" * 40)
    report.append(f"æˆåŠŸçŽ‡: {success}/{total} ({success/total*100:.1f}%)")
    report.append("=" * 40)
    
    # ä¿å­˜å ±å‘Š
    filename = f"api_test_report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt"
    with open(filename, 'w') as f:
        f.write("\n".join(report))
    
    print(f"å ±å‘Šå·²ä¿å­˜: {filename}")
    print(f"æˆåŠŸçŽ‡: {success}/{total} ({success/total*100:.1f}%)")

if __name__ == "__main__":
    asyncio.run(main())
EOF
        
        # é‹è¡Œæ¸¬è©¦
        cd scripts
        python test_exchanges.py

    - name: ðŸ’¾ ä¿å­˜æ¸¬è©¦å ±å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: api-test-results
        path: |
          scripts/api_test_report_*.txt
          api_test_report_*.txt
        retention-days: 30

    - name: ðŸ“ ç”Ÿæˆæ¸¬è©¦æ‘˜è¦
      run: |
        echo "## ðŸ“Š API æ¸¬è©¦çµæžœæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**å®Œæˆæ™‚é–“:** $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # å°‹æ‰¾å ±å‘Šæ–‡ä»¶
        for report in scripts/api_test_report_*.txt api_test_report_*.txt; do
          if [ -f "$report" ]; then
            echo "**æ¸¬è©¦çµæžœ:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat "$report" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            break
          fi
        done
